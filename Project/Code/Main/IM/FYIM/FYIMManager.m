//
//  FYIMManager.m
//  Project
//
//  Created by Mike on 2019/4/2.
//  Copyright ¬© 2019 CDJay. All rights reserved.
//

#import "FYIMManager.h"
#import "BANetManager_OC.h"
#import "FYIMMessageManager.h"
#import "ChatViewController.h"
#import "SqliteManage.h"
#import "SSKeychain.h"
#import "GTMBase64.h"
#import "NSData+AES.h"
#import "MessageSingle.h"
#import "PushMessageModel.h"
#import "FYContacts.h"
#import "IMMessageModule.h"

@implementation FYIMManager

+ (FYIMManager *)shareInstance {
    static FYIMManager *instance = nil;
    static dispatch_once_t predicate;
    dispatch_once(&predicate, ^{
        instance = [[[self class] alloc] init];
    });
    return instance;
}

- (instancetype)init {
    self = [super init];
    if (self) {
        [self onConnectSocket];
        [FYIMMessageManager shareInstance].receiveMessageDelegate = self;
        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(onConnectSocket) name:kOnConnectSocketNotification object:nil];
        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(onLoggedSuccess) name:kLoggedSuccessNotification object:nil];
        [IMSessionModule getAllSessions];

    }
    return self;
}

-(void)dealloc {
    [[NSNotificationCenter defaultCenter] removeObserver:self];
}


/**
 Êõ¥Êñ∞Á∫¢ÂåÖ‰ø°ÊÅØ
 
 @param messageId Ê∂àÊÅØID
 @param redEnvelopeMessage Êõ¥ÊîπÂêéÁöÑÁ∫¢ÂåÖÊ®°Âûã
 */
- (void)setRedEnvelopeMessage:(NSString *)messageId redEnvelopeMessage:(EnvelopeMessage *)redEnvelopeMessage {
    [[FYIMMessageManager shareInstance] setRedEnvelopeMessage:messageId redEnvelopeMessage:redEnvelopeMessage];
}

- (void)onConnectSocket {
    
    if ([FYIMMessageManager shareInstance].isConnectFY) {
        return;
    }
    if ([AppModel shareInstance].commonInfo[@"ws_url"] == nil) {
        return;
    }
    // Áî®Êà∑token
    if ([AppModel shareInstance].userInfo.token != nil) {
        [BANetManager initialize];
        [[FYIMMessageManager shareInstance] initWithAppKey:[AppModel shareInstance].userInfo.token];
    } else {
        //        [self getFYToken];
        if([AppModel shareInstance].userInfo.isLogined == YES) {
            [[AppModel shareInstance] logout];
        }
    }
}
- (void)onLoggedSuccess {
    [self notificationLogin];
}

- (void)onTokenInvalid {
    [FYIMMessageManager shareInstance].isConnectFY = NO;
    [AppModel shareInstance].userInfo.token = nil;
    [AppModel shareInstance].userInfo.fullToken = nil;
//    [self getFYToken];
    if([AppModel shareInstance].userInfo.isLogined == YES) {
        [[AppModel shareInstance] logout];
    }
}


#pragma mark - FYReceiveMessageDelegate Ê∂àÊÅØÊù•Ê∫ê
- (void)onFYIMReceiveMessage:(FYMessage *)message messageCount:(NSInteger)messageCount left:(NSInteger)left {
    NSInteger number = 0;
    NSString *tid = nil;
    
    ChatViewController *vc = [ChatViewController currentChat];
    if (vc) {
        tid = vc.sessionId;
    }
    number = ([tid isEqualToString:message.sessionId]) ? 0 : 1;
    NSString *lastMessage = [IMMessageModule.sharedInstance filterMessageToShowMessage:message];
    [self updateGroup:message.sessionId number:number lastMessage:lastMessage messageCount:messageCount left:left chatType: message.chatType];
    ///ËÆ∞Âæó‰πãÂêé Ë¶ÅËøáÊª§ÊéâÂÆòÊñπÁæ§ÁöÑsessionÂíåÊ∂àÊÅØ
    [IMSessionModule.sharedInstance insertFYContacts:message lastMessage:lastMessage];
    [[NSNotificationCenter defaultCenter] postNotificationName:kUnreadMessageNumberChange object:@"MyFriendListNotification"];
}


- (void)updateGroup:(NSString *)sessionId number:(NSInteger)number lastMessage:(NSString *)last messageCount:(NSInteger)messageCount left:(NSInteger)left chatType:(FYChatConversationType)chatType {
    NSString *queryId = [NSString stringWithFormat:@"%@-%@",sessionId,[AppModel shareInstance].userInfo.userId];
    PushMessageModel *oldModel = (PushMessageModel *)[MessageSingle shareInstance].allUnreadMessagesDict[queryId];
    
    if (oldModel) {
        if (number == 0) {
            [AppModel shareInstance].unReadCount -= oldModel.number;
            if (chatType == FYConversationType_PRIVATE) {
                [AppModel shareInstance].friendUnReadTotal -= oldModel.number;
            }
            
//            else if (chatType == FYConversationType_CUSTOMERSERVICE) {
//                [AppModel shareInstance].customerServiceUnReadTotal -= oldModel.number;
//            }
            oldModel.number = 0;
        } else {
            if (oldModel.number > 99) {
                return;
            }
            oldModel.number += 1;
            [AppModel shareInstance].unReadCount += 1;
            if (chatType == FYConversationType_PRIVATE) {
                [AppModel shareInstance].friendUnReadTotal += 1;
            }
            
//            else if (chatType == FYConversationType_CUSTOMERSERVICE) {
//                [AppModel shareInstance].customerServiceUnReadTotal += 1;
//            }
            oldModel.messageCountLeft = messageCount;
        }
        
        if (last.length >0) {
            oldModel.lastMessage = last;
        }
        [[MessageSingle shareInstance].allUnreadMessagesDict setObject:oldModel forKey:queryId];
    } else {
        if (number == 0) {
            return;
        }
        
        [AppModel shareInstance].unReadCount += 1;
        if (chatType == FYConversationType_PRIVATE) {
            [AppModel shareInstance].friendUnReadTotal += 1;
        }
        
//        else if (chatType == FYConversationType_CUSTOMERSERVICE) {
//            [AppModel shareInstance].customerServiceUnReadTotal += 1;
//        }
        PushMessageModel *newModel = [PushMessageModel new];
        newModel.userId = [AppModel shareInstance].userInfo.userId;
        newModel.number = 1;
        newModel.lastMessage = last;
        newModel.sessionId = sessionId;
        newModel.messageCountLeft = messageCount;
        
        [[MessageSingle shareInstance].allUnreadMessagesDict setObject:newModel forKey:queryId];
        
    }
    
    if ((left == 0 && oldModel.number <= 99) || (messageCount > 0 && left == 0)) {
        [[NSNotificationCenter defaultCenter] postNotificationName:kUnreadMessageNumberChange object:@"GroupListNotification"];
    }
    if (oldModel.number == 0 || [AppModel shareInstance].unReadCount == 1) {
        [[NSNotificationCenter defaultCenter] postNotificationName:kUnreadMessageNumberChange object:@"updateBadeValue"];
    }
}




#pragma mark - Ëé∑ÂèñIM Token
/**
 Ëé∑ÂèñIM Token
 */
- (void)getFYToken {
    
//    NSString *password = [SSKeychain passwordForService:@"password" account:[AppModel shareInstance].userInfo.mobile];
//    if (password == nil) {
//        if([AppModel shareInstance].userInfo.isLogined == YES) {
//            [[AppModel shareInstance] logout];
//        }
//        return;
//    }
//    SVP_SHOW_STATUS(@"Áî®Êà∑‰ø°ÊÅØÂä†ËΩΩ‰∏≠...");
//    __weak __typeof(self)weakSelf = self;
//    [NET_REQUEST_MANAGER requestTockenWithAccount:[AppModel shareInstance].userInfo.mobile password:password success:^(id object) {
//        SVP_DISMISS;
//        if([object isKindOfClass:[NSDictionary class]]){
//            NSDictionary* response = object[@"data"];
//            if (![FunctionManager isEmpty:response[@"userId"]]) {
//                
//                [SSKeychain setPassword:password forService:@"password" account:[AppModel shareInstance].userInfo.mobile];
//                SetUserDefaultKeyWithObject(@"mobile", [AppModel shareInstance].userInfo.mobile);
//                UserDefaultSynchronize;
//                
//                
//                NSLog(@"************** Token: %@ **************", [response objectForKey:@"access_token"]);
//                [AppModel shareInstance].userInfo.token = [response objectForKey:@"access_token"];
//                [AppModel shareInstance].userInfo.fullToken = [NSString stringWithFormat:@"%@",[AppModel shareInstance].userInfo.token];
//                
//                [[AppModel shareInstance] saveAppModel];
//                if ([AppModel shareInstance].userInfo.token.length > 0) {
//                    [weakSelf onConnectSocket];
//                }
//            }
//        }else {
//            NSLog(@"************** üî¥Ëé∑ÂèñTokenÂ§±Ë¥• %@**************",object);
//            if([AppModel shareInstance].userInfo.isLogined == YES) {
//                [[AppModel shareInstance] logout];
//                SVP_ERROR_STATUS(@"Áî®Êà∑‰ø°ÊÅØÂ∑≤Â§±ÊïàÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï");
//            }
//        }
//    }  fail:^(id object) {
//        SVP_DISMISS;
//        NSLog(@"************** üî¥Ëé∑Âèñ TokenÂ§±Ë¥• %@**************",object);
//        if([AppModel shareInstance].userInfo.isLogined == YES) {
//            [[AppModel shareInstance] logout];
//            SVP_ERROR_STATUS(@"Áî®Êà∑‰ø°ÊÅØÂ∑≤Â§±ÊïàÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï");
//        }
//    }];
    
    //    NSData *data = [password dataUsingEncoding:NSUTF8StringEncoding];
    //    data = [data AES128EncryptWithKey:kAccountPasswordKey gIv:kAccountPasswordKey];
    //    data = [GTMBase64 encodeData:data];
    //    NSString *passswordS = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
    //    passswordS = [[FunctionManager sharedInstance] encodedWithString:passswordS];
    //
    //    BADataEntity *entity = [BADataEntity new];
    //    entity.urlString = [NSString stringWithFormat:@"%@%@?username=%@&password=%@&randomStr=82701535096009570&code=5app&grant_type=password&scope=server",[AppModel shareInstance].serverUrl,@"auth/oauth/token", [AppModel shareInstance].userInfo.mobile, passswordS];
    //    entity.needCache = NO;
    //
    //    [[BANetManager sharedBANetManager].sessionManager.requestSerializer setValue:[AppModel shareInstance].authKey forHTTPHeaderField:@"Authorization"];
    //
    //    SVP_SHOW_STATUS(@"Áî®Êà∑‰ø°ÊÅØÂä†ËΩΩ‰∏≠...");
    //    __weak __typeof(self)weakSelf = self;
    //    [BANetManager ba_request_POSTWithEntity:entity successBlock:^(id response) {
    //        SVP_DISMISS;
    ////        __strong __typeof(weakSelf)strongSelf = weakSelf;
    //        if ([response isKindOfClass:[NSDictionary class]]) {
    //            NSLog(@"************** Token: %@ **************", [response objectForKey:@"access_token"]);
    //            [AppModel shareInstance].userInfo.token = [response objectForKey:@"access_token"];
    //            [AppModel shareInstance].userInfo.fullToken = [NSString stringWithFormat:@"%@",[AppModel shareInstance].userInfo.token];
    //
    //            [[AppModel shareInstance] saveAppModel];
    //            if ([AppModel shareInstance].userInfo.token.length > 0) {
    //                [weakSelf onConnectSocket];
    //            }
    //        } else {
    //            NSLog(@"************** üî¥Ëé∑ÂèñTokenÂ§±Ë¥• %@**************",response);
    //            if([AppModel shareInstance].userInfo.isLogined == YES) {
    //                [[AppModel shareInstance] logout];
    //                SVP_ERROR_STATUS(@"Áî®Êà∑‰ø°ÊÅØÂ∑≤Â§±ÊïàÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï");
    //            }
    //        }
    //    } failureBlock:^(NSError *error) {
    //        SVP_DISMISS;
    //        NSLog(@"************** üî¥Ëé∑Âèñ TokenÂ§±Ë¥• %@**************",error);
    //        if([AppModel shareInstance].userInfo.isLogined == YES) {
    //            [[AppModel shareInstance] logout];
    //            SVP_ERROR_STATUS(@"Áî®Êà∑‰ø°ÊÅØÂ∑≤Â§±ÊïàÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï");
    //        }
    //    } progressBlock:nil];
}

/**
 ÈÄöÁü•ÊúçÂä°Âô® ÁôªÂΩï‰∫Ü
 */
- (void)notificationLogin {
    
    BADataEntity *entity = [BADataEntity new];
    entity.urlString = [NSString stringWithFormat:@"%@%@",[AppModel shareInstance].serverUrl,@"social/basic/appLogin"];
    entity.needCache = NO;
    //    __weak __typeof(self)weakSelf = self;
    [BANetManager ba_request_POSTWithEntity:entity successBlock:^(id response) {
        //        __strong __typeof(weakSelf)strongSelf = weakSelf;
        if ([response objectForKey:@"code"] && [[response objectForKey:@"code"] integerValue] == 0) {
        } else {
        }
    } failureBlock:^(NSError *error) {
        NSLog(@"-----------notificationLogin-----------");
    } progressBlock:nil];
}


//ËÆæÁΩÆÁæ§ÁªÑÈÄöÁü•Ê∂àÊÅØÊ≤°ÊúâÊèêÁ§∫Èü≥  NO ÊúâÂ£∞Èü≥
- (BOOL)onFYIMCustomAlertSound:(FYMessage *)message {
    
    if (message.chatType == FYConversationType_PRIVATE) {
        NSString *query = [NSString stringWithFormat:@"sessionId='%@' AND accountUserId='%@'",message.sessionId,[AppModel shareInstance].userInfo.userId];
        
        FYContacts *conModel = [[WHC_ModelSqlite query:[FYContacts class] where:query] firstObject];
        return conModel.isNotDisturbSound;
        
    } else {
        //    ÂΩìÂ∫îÁî®Â§Ñ‰∫éÂâçÂè∞ËøêË°åÔºåÊî∂Âà∞Ê∂àÊÅØ‰∏ç‰ºöÊúâÊèêÁ§∫Èü≥„ÄÇ
        NSString *switchKeyStr = [NSString stringWithFormat:@"%@-%@", [AppModel shareInstance].userInfo.userId,message.sessionId];
        // ËØªÂèñ
        BOOL isSwitch = [[NSUserDefaults standardUserDefaults] boolForKey:switchKeyStr];
        return isSwitch;
    }
}

/**
 Áî®Êà∑‰∏ªÂä®ÈÄÄÂá∫ÁôªÂΩï
 */
- (void)userSignout {
    [[FYIMMessageManager shareInstance] userSignout];
    [WHC_ModelSqlite removeModel:[PushMessageModel class]];
    [[MessageSingle shareInstance].allUnreadMessagesDict removeAllObjects];
}

@end
